# Istio

You'll find some information in here which should help you get keptn + Istio + Cert-Manger up and running.

There are a lot of differences and requirements depending on what resolver (HTTP vs DNS) you want to use and which version of Istio you are using. So please read carefully.

Further I can't garantee that it works at the end. It was a lot of trial and error on my side and I tried to write all information together by processing my notes from several days/weeks. If you go through this the first time, don't do it in your production environment ;)

- [Istio](#istio)
  - [What is working right now](#what-is-working-right-now)
  - [ToDo's](#todos)
  - [Initial thoughts](#initial-thoughts)
  - [Issuing certificates](#issuing-certificates)
    - [Using Istio <v1.5 (go this route if you installed Istio with keptn)](#using-istio-v15-go-this-route-if-you-installed-istio-with-keptn)
    - [Using Istio <v1.5 without SDS **EXPERIMENTAL**](#using-istio-v15-without-sds-experimental)
    - [Using Istio v1.5](#using-istio-v15)
  - [Automatically create/delete Route53 entrys with external-dns](#automatically-createdelete-route53-entrys-with-external-dns)

## What is working right now

1. Issuing certificates with the help of [Cert-Manager](https://cert-manager.io/)
2. Using [SDS](https://istio.io/pt-br/docs/tasks/security/citadel-config/auth-sds/) to pass certificates as secrets to your gateways instead of mounting them.
3. Automatically create and, if you like, remove Route53 entrys as soon as you make changes to the host section of your gateways

## ToDo's

- Issue a new certificate if you add a new host to your Istio gateways

<br>

## Initial thoughts

Before we get started, I'd recommend to use Istio v1.5 from now on since it greatly reduced the resources consumption of the Istio control plane. Further it is now managed by an operator and easier to configure before and afterwards. 

If you already have Istio running or want to install Istio v1.5 before installing keptn, there is now a way to use your existing Istio installation without breaking the installation of keptn. https://keptn.sh/docs/0.6.0/reference/managed_istio/

```
keptn install --platform=<YOUR_PLATFORM> --istio-install-option=Reuse
```

Because keptn, atm, comes with Istio 1.3.1, I wrote kind of a walkthrough for version v1.5 and for <v1.5. 

<br>

## Issuing certificates

### Using Istio <v1.5 (go this route if you installed Istio with keptn)

If you are installing keptn with Istio, v1.3.1 will be installed. Therefore you need to enable using [SDS](https://istio.io/pt-br/docs/tasks/security/citadel-config/auth-sds/). This will spawn a lot more pods in the Istio Namespace because it needs additional components. **That will eat a lot more ressources, so be warned.** 

**If you'd like to try to save some ressources, you can go to the next chapter and try the experimental way, without enabling SDS.**

<br>

1. If not already installed, get istioctl: https://istio.io/docs/setup/getting-started/#download
   -  You'll probably need the fitting `istioctl` version to communicate
      ```
      curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.3.1 sh -
      ```
2. Install Cert-Manager as described here: https://cert-manager.io/docs/installation/kubernetes/
3. Decide which resolver you want to use: https://cert-manager.io/docs/configuration/acme/
   1. **For HTTP resolvers only** 

      1. Create the necessary `istio-autogenerated-k8s-ingress` and `ingressgateway` gateways which will be used for issuing the certificates by using this command:
      
          - Don't ask me why this is needed, but it won't work with your keptn gateway! You can read more on this [here](https://github.com/istio/istio/issues/13113#issuecomment-480612822)
          - Because this gateway will have a wildcard for port 80, you need to make sure that there is no wildcard in your keptn gateway if you have port 80 open there as well!  
        
          ```
          istioctl manifest apply \
          --set values.global.k8sIngress.enabled=true \
          --set values.global.k8sIngress.enableHttps=false \
          --set values.global.k8sIngress.gatewayName=ingressgateway
          --set values.gateways.istio-ingressgateway.sds.enabled=true
          ```

       1. Create an Issuer or Cluster-Issuer
      
          - The difference between both is just, that the Cluster-Issuer can be used Cluster-Wide and the Issue only within the same namespace.
          - Grab the `example/http-issuer.yaml` and edit it to your needs.
          - Apply it.

   2. **For DNS resolvers only**
      - I can just speak for Route53, but you'll find other providers in the documentation of cert-manager.

       1. Following this [guide](https://cert-manager.io/docs/configuration/acme/dns01/route53/) to setup your DNS provider. At the end you should have your `accessKeyID`.

       2. Create an Issuer or Cluster-Issuer

       - The difference between both is just, that the Cluster-Issuer can be used Cluster-Wide and the Issue only within the same namespace.
       - Grab the `example/dns-issuer.yaml` and edit it to your needs.
       - Apply it.

4. Create the certificate

   1. **For HTTP resolvers only** 
       
         - Grab the `example/http-certificate.yaml` and edit it to your needs.
         - Apply it.
  
   2. **For DNS resolvers only** 
      
         - Grab the `example/dns-certificate.yaml` and edit it to your needs.
         - Apply it.


5. You can check if your certificate got created or where it's stuck by checking out the following commands:

    ```
    k -n istio-system describe certificates.cert-manager.io
    k -n istio-system describe certificaterequests.cert-manager.io
    k -n istio-system describe orders.acme.cert-manager.io
    ```

6. Now edit your `keptn public-gateway` to make use of this secret / certificate you just created.
    
    ```
    kubectl -n istio-system \
    patch gateway public-gateway --type=json \
    -p='[{"op": "replace", "path": "/spec/servers/1/tls", "value": {"credentialName": "<SECRET_WHICH_STORES_CERT>", "mode": "SIMPLE", "privateKey": "sds", "serverCertificate": "sds"}}]'
    ```

7. You're done!

<br>

### Using Istio <v1.5 without SDS **EXPERIMENTAL**

I never tried this option but I was thinking about this. As mentioned above, activating SDS with keptn version lower than 1.5, it will spawn a lot of pods and Istio will eat up your ressources. So I had an idea but was not able to test it yet.

Maybe it is possible to use it without acitvating SDS. Therefore you should follow the steps from Using Istio v1.5. If you reach the point of creating the certifcate ressources use this .yamls instead. 

<br>

4. Create the certificate

   1. **For HTTP resolvers only** 
       
         - Grab the `example/experimental/http-certificate.yaml` and edit it to your needs.
         - Apply it.
  
   2. **For DNS resolvers only** 
      
         - Grab the `example/experimental/dns-certificate.yaml` and edit it to your needs.
         - Apply it.

What is the difference here? The secret which stores the certificate is hardcoded to `istio-ingressgateway-certs`. This secret is mounted as a volume to the Istio control plane, so Istio can pick it up. But if you go this route, you can only have one cert in your cluster (enough to get started with keptn).

<br>

### Using Istio v1.5

1. If not already installed, get istioctl: https://istio.io/docs/setup/getting-started/#download
2. Install Cert-Manager as described here: https://cert-manager.io/docs/installation/kubernetes/
3. Decide which resolver you want to use: https://cert-manager.io/docs/configuration/acme/
   1. **For HTTP resolvers only** 

      1. Create the necessary `istio-autogenerated-k8s-ingress` and `ingressgateway` gateways which will be used for issuing the certificates by using this command:
      
          - Don't ask me why this is needed, but it won't work with your keptn gateway! You can read more on this [here](https://github.com/istio/istio/issues/13113#issuecomment-480612822)
          - Because this gateway will have a wildcard for port 80, you need to make sure that there is no wildcard in your keptn gateway if you have port 80 open there as well!  
        
          ```
          istioctl manifest apply \
          --set values.global.k8sIngress.enabled=true \
          --set values.global.k8sIngress.enableHttps=false \
          --set values.global.k8sIngress.gatewayName=ingressgateway
          ```

       1. Create an Issuer or Cluster-Issuer
      
          - The difference between both is just, that the Cluster-Issuer can be used Cluster-Wide and the Issue only within the same namespace.
          - Grab the `example/http-issuer.yaml` and edit it to your needs.
          - Apply it.

   2. **For DNS resolvers only**
      - I can just speak for Route53, but you'll find other providers in the documentation of cert-manager.

       1. Following this [guide](https://cert-manager.io/docs/configuration/acme/dns01/route53/) to setup your DNS provider. At the end you should have your `accessKeyID`.

       2. Create an Issuer or Cluster-Issuer

       - The difference between both is just, that the Cluster-Issuer can be used Cluster-Wide and the Issue only within the same namespace.
       - Grab the `example/dns-issuer.yaml` and edit it to your needs.
       - Apply it.

4. Create the certificate

   1. **For HTTP resolvers only** 
       
         - Grab the `example/http-certificate.yaml` and edit it to your needs.
         - Apply it.
  
   2. **For DNS resolvers only** 
      
         - Grab the `example/dns-certificate.yaml` and edit it to your needs.
         - Apply it.


5. You can check if your certificate got created or where it's stuck by checking out the following commands:

    ```
    k -n istio-system describe certificates.cert-manager.io
    k -n istio-system describe certificaterequests.cert-manager.io
    k -n istio-system describe orders.acme.cert-manager.io
    ```

6. Now edit your `keptn public-gateway` to make use of this secret / certificate you just created.
    
    ```
    kubectl -n istio-system \
    patch gateway public-gateway --type=json \
    -p='[{"op": "replace", "path": "/spec/servers/1/tls", "value": {"credentialName": "<SECRET_WHICH_STORES_CERT>", "mode": "SIMPLE", "privateKey": "sds", "serverCertificate": "sds"}}]'
    ```

7. You're done!

<br>

## Automatically create/delete Route53 entrys with external-dns

To be continued ...